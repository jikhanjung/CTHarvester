name: Release

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  call-build-workflow:
    uses: ./.github/workflows/reusable_build.yml
    with:
      build_number: ${{ github.run_number }}

  create-release:
    needs: call-build-workflow
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-files/

    - name: Display structure of downloaded files
      run: ls -la release-files/*/

    - name: Extract tag version
      id: get_tag
      run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Check if prerelease
      id: check_prerelease
      run: |
        if [[ "${{ steps.get_tag.outputs.TAG_NAME }}" == *"beta"* ]] || [[ "${{ steps.get_tag.outputs.TAG_NAME }}" == *"alpha"* ]] || [[ "${{ steps.get_tag.outputs.TAG_NAME }}" == *"rc"* ]]; then
          echo "PRERELEASE=true" >> $GITHUB_OUTPUT
        else
          echo "PRERELEASE=false" >> $GITHUB_OUTPUT
        fi

    - name: Extract changelog for this version
      id: changelog
      run: |
        VERSION="${{ steps.get_tag.outputs.TAG_NAME }}"

        # Try to extract specific version section from CHANGELOG.md
        if grep -q "## \[${VERSION}\]" CHANGELOG.md 2>/dev/null; then
          # Extract between this version and next ## heading
          NOTES=$(sed -n "/## \[${VERSION}\]/,/^## \[/p" CHANGELOG.md | sed '$d' | tail -n +2)
        elif grep -q "## \[Unreleased\]" CHANGELOG.md 2>/dev/null; then
          # Use Unreleased section if version-specific section not found
          NOTES=$(sed -n "/## \[Unreleased\]/,/^## \[/p" CHANGELOG.md | sed '$d' | tail -n +2)
        else
          # Fallback message if no changelog found
          NOTES="See [CHANGELOG.md](https://github.com/jikhanjung/CTHarvester/blob/main/CHANGELOG.md) for details."
        fi

        # Save to file (multiline output handling)
        {
          echo "CHANGELOG_CONTENT<<EOF"
          echo "$NOTES"
          echo "EOF"
        } >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get_tag.outputs.TAG_NAME }}
        name: CTHarvester ${{ steps.get_tag.outputs.TAG_NAME }}
        body: |
          # ðŸš€ CTHarvester ${{ steps.get_tag.outputs.TAG_NAME }}

          ${{ steps.changelog.outputs.CHANGELOG_CONTENT }}

          ---

          ## ðŸ“¦ Installation

          Download the appropriate file for your platform:
          - **Windows**: CTHarvester-Windows-Installer-*.zip (extract and run installer)
          - **macOS**: CTHarvester-macOS-Installer-*.dmg (mount and drag to Applications)
          - **Linux**: CTHarvester-Linux-*.AppImage (make executable and run)

          ## ðŸ“‹ Build Information

          - **Built from commit:** ${{ github.sha }}
          - **Build number:** ${{ github.run_number }}
          - **Date:** ${{ github.event.head_commit.timestamp }}

          ## ðŸ“– Documentation

          - [User Guide](https://jikhanjung.github.io/CTHarvester/en/user_guide.html)
          - [Full Changelog](https://github.com/jikhanjung/CTHarvester/blob/main/CHANGELOG.md)
          - [Troubleshooting](https://github.com/jikhanjung/CTHarvester/blob/main/docs/user_guide/troubleshooting.rst)
        prerelease: ${{ steps.check_prerelease.outputs.PRERELEASE }}
        files: |
          release-files/ctharvester-windows/CTHarvester-Windows-*.zip
          release-files/ctharvester-macos/CTHarvester-macOS-*.dmg
          release-files/ctharvester-linux/CTHarvester-Linux-*.AppImage
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
