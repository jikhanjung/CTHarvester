# CTHarvester

[![Build](https://github.com/jikhanjung/CTHarvester/actions/workflows/build.yml/badge.svg)](https://github.com/jikhanjung/CTHarvester/actions/workflows/build.yml)
[![Tests](https://github.com/jikhanjung/CTHarvester/actions/workflows/test.yml/badge.svg)](https://github.com/jikhanjung/CTHarvester/actions/workflows/test.yml)
[![Release Status](https://github.com/jikhanjung/CTHarvester/actions/workflows/release.yml/badge.svg)](https://github.com/jikhanjung/CTHarvester/actions/workflows/release.yml)
[![codecov](https://codecov.io/gh/jikhanjung/CTHarvester/branch/main/graph/badge.svg)](https://codecov.io/gh/jikhanjung/CTHarvester)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Python 3.11+](https://img.shields.io/badge/python-3.11+-blue.svg)](https://www.python.org/downloads/)
[![Tests: 195 passing](https://img.shields.io/badge/tests-195%20passing-brightgreen.svg)](https://github.com/jikhanjung/CTHarvester/tree/main/tests)

*Read this in other languages: [English](README.md), [한국어](README.ko.md)*

A preprocessing tool for CT (Computed Tomography) image stacks designed for users with limited memory resources. CTHarvester enables efficient cropping and resampling of large CT datasets without loading the entire volume into memory, using Level of Detail (LoD) techniques for fast preview and navigation.

## Features

### Memory-Efficient Processing
- **Smart Cropping**: Extract only the regions of interest from large CT datasets without loading entire volumes
- **Level of Detail (LoD)**: Multi-resolution pyramid for fast preview and navigation
- **Streaming Processing**: Process CT stacks slice-by-slice to minimize memory usage
- **Efficient Resampling**: Create downsampled versions for quick visualization on low-spec machines

### Core Functionality
- **Interactive Region Selection**: Define crop boundaries visually before processing
- **Real-time Preview**: Fast 3D preview using LoD techniques
- **Multi-level Output**: Generate multiple resolution levels (1/2, 1/4, 1/8, etc.)
- **Batch Processing**: Process multiple CT stacks efficiently with multithreading
- **Smart Memory Management**: Optimized for systems with limited RAM

### Visualization Features
- **3D Rendering**: OpenGL-based visualization with LoD support
- **Marching Cubes**: Generate 3D mesh models from cropped regions
- **Threshold Control**: Interactive threshold adjustment for optimal visualization
- **Inverse Mode**: Support for inverse density visualization

### User Interface
- **Intuitive GUI**: Built with PyQt5 for a native desktop experience
- **Real-time Preview**: Instant feedback on adjustments and processing
- **Multi-language Support**: Available in English and Korean
- **Customizable Settings**: Remember window geometry and working directories

## Installation

### Windows Installer
Download the latest installer from the [Releases](https://github.com/jikhanjung/CTHarvester/releases) page.

### From Source

#### Prerequisites
- Python 3.11 or higher
- pip package manager

#### Steps
1. Clone the repository:
```bash
git clone https://github.com/jikhanjung/CTHarvester.git
cd CTHarvester
```

2. Install dependencies:
```bash
# Recommended: Install from pyproject.toml
pip install -e .

# Or use requirements.txt for backward compatibility
pip install -r requirements.txt
```

3. For development with additional tools:
```bash
pip install -e .[dev]
```

4. Run the application:
```bash
python CTHarvester.py
```

## Usage

### Basic Workflow

1. **Open Directory**: Click "Open dir." to select a directory containing CT image files
   - The tool automatically creates a low-resolution preview for fast navigation
2. **Navigate with LoD**: Browse through the dataset quickly using the multi-level preview
3. **Set Crop Region**: 
   - Click "Set Bottom" to define the bottom boundary
   - Click "Set Top" to define the top boundary
   - Use "Reset" to clear the selection
4. **Adjust Threshold**: Use the vertical slider to fine-tune the visualization
5. **Process**: Click "Resample" to create multiple resolution levels
   - Original resolution (cropped region only)
   - 1/2, 1/4, 1/8 resolutions for different use cases
6. **Save/Export**: 
   - "Save cropped image stack" to save only the region of interest
   - "Export 3D Model" to generate a mesh from the cropped data

### Supported File Formats
- **Input**: BMP, JPG, PNG, TIF, TIFF
- **Output**: Same as input formats
- **3D Export**: STL, PLY, OBJ

### Log File Support
CTHarvester can automatically read reconstruction settings from log files generated by CT scanning software.

## Development

### Building from Source

#### Windows
```bash
python build.py
```
This will create both the executable and installer.

#### macOS/Linux
```bash
python build.py
```
This will create the executable for your platform.

### Version Management
```bash
# Bump patch version (0.2.0 -> 0.2.1)
python manage_version.py bump patch

# Bump minor version (0.2.0 -> 0.3.0)
python manage_version.py bump minor

# Bump major version (0.2.0 -> 1.0.0)
python manage_version.py bump major
```

### Testing

CTHarvester has comprehensive test coverage across unit and integration tests.

#### Running Tests
```bash
# Run all tests
pytest tests/ -v

# Run with coverage report
pytest tests/ -v --cov=. --cov-report=term-missing --cov-report=html

# Run specific test categories
pytest tests/ -v -m unit              # Unit tests only
pytest tests/ -v -m integration       # Integration tests only
pytest tests/ -v -m "not slow"        # Skip slow tests
```

#### Test Structure
- **Unit Tests** (186 tests): Core utilities, workers, image processing, security
  - `test_common.py` - Utility functions (29 tests, 100% coverage)
  - `test_worker.py` - Worker threads (22 tests, 100% coverage)
  - `test_image_utils.py` - Image processing (31 tests, 100% coverage)
  - `test_progress_manager.py` - Progress tracking (28 tests, 99% coverage)
  - `test_file_utils.py` - File operations (41 tests, 94% coverage)
  - `test_security.py` - Security validation (36 tests, 90% coverage)

- **Integration Tests** (9 tests): End-to-end workflows
  - `test_integration_thumbnail.py` - Thumbnail generation pipeline

#### Coverage
- **Overall**: ~95% for core utility modules
- **Modules at 100%**: utils/common, utils/worker, utils/image_utils
- **Total**: 195 tests, all passing ✅

### CI/CD
The project uses GitHub Actions for continuous integration and deployment:
- **test.yml**: Runs tests on all pushes and PRs
  - Runs on Python 3.12 and 3.13
  - Generates coverage reports
  - Uploads to Codecov
- **build.yml**: Creates development builds on main branch
- **release.yml**: Creates release builds on version tags

## Project Structure

```
CTHarvester/
├── CTHarvester.py          # Main application entry point
├── version.py              # Version management
├── build.py                # Build script for packaging
├── manage_version.py       # Version bump utility
├── requirements.txt        # Python dependencies
├── pytest.ini              # Test configuration
│
├── core/                   # Core modules (extracted from Phase 4 refactoring)
│   ├── progress_manager.py    # Progress tracking and ETA calculation
│   ├── thumbnail_manager.py   # Thumbnail generation coordinator
│   └── thumbnail_worker.py    # Worker threads for thumbnail processing
│
├── utils/                  # Utility modules
│   ├── common.py              # Common utility functions
│   ├── file_utils.py          # File system operations
│   ├── image_utils.py         # Image processing utilities
│   └── worker.py              # Generic worker thread base
│
├── security/               # Security validation
│   └── file_validator.py     # File path and security checks
│
├── ui/                     # User interface modules
│   ├── main_window.py         # Main application window
│   └── widgets/               # Custom Qt widgets
│
├── config/                 # Configuration
│   └── constants.py           # Application constants
│
├── .github/
│   └── workflows/         # GitHub Actions CI/CD
│       ├── test.yml           # Test automation with coverage
│       ├── build.yml          # Development builds
│       └── release.yml        # Release builds
│
├── tests/                 # Comprehensive test suite (195 tests)
│   ├── test_common.py         # Utility function tests
│   ├── test_worker.py         # Worker thread tests
│   ├── test_image_utils.py    # Image processing tests
│   ├── test_progress_manager.py  # Progress tracking tests
│   ├── test_file_utils.py     # File operation tests
│   ├── test_security.py       # Security validation tests
│   └── test_integration_thumbnail.py  # Integration tests
│
├── InnoSetup/             # Windows installer configuration
└── devlog/                # Development logs and documentation
    ├── 20250930_020-025_*.md  # Refactoring documentation
    ├── 20250930_026-028_*.md  # Test coverage documentation
    └── ...
```

## Dependencies

- **PyQt5**: GUI framework
- **PyOpenGL**: 3D rendering
- **NumPy**: Numerical computations
- **SciPy**: Scientific computing
- **Pillow**: Image processing
- **PyMCubes**: Marching cubes implementation
- **SuperQt**: Enhanced Qt widgets

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.

### Development Setup

1. Fork the repository
2. Clone your fork:
   ```bash
   git clone https://github.com/YOUR_USERNAME/CTHarvester.git
   cd CTHarvester
   ```

3. Install dependencies:
   ```bash
   pip install -r requirements.txt
   pip install pytest pytest-cov pytest-qt  # For testing
   ```

4. Create your feature branch:
   ```bash
   git checkout -b feature/AmazingFeature
   ```

### Development Workflow

1. **Make your changes**
   - Follow existing code style and patterns
   - Add docstrings to new functions/classes
   - Update tests if needed

2. **Run tests**
   ```bash
   pytest tests/ -v
   ```

3. **Check coverage**
   ```bash
   pytest tests/ --cov=. --cov-report=term-missing
   ```

4. **Commit your changes**
   ```bash
   git commit -m 'Add some AmazingFeature'
   ```

5. **Push to your fork**
   ```bash
   git push origin feature/AmazingFeature
   ```

6. **Open a Pull Request**
   - Describe your changes clearly
   - Reference any related issues
   - Ensure CI checks pass

### Code Quality Guidelines

- **Testing**: Add tests for new features
- **Coverage**: Maintain >90% coverage for new modules
- **Documentation**: Update README and docstrings
- **Style**: Follow PEP 8 conventions
- **Security**: Use security/file_validator for file operations

### Project Architecture

CTHarvester follows a modular architecture after Phase 4 refactoring:
- **core/**: Core business logic (progress, thumbnail generation)
- **utils/**: Reusable utility functions
- **security/**: Security validation layer
- **ui/**: User interface components
- **tests/**: Comprehensive test suite

See `devlog/` for detailed refactoring and development notes.

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## Author

**Jikhan Jung**
- GitHub: [@jikhanjung](https://github.com/jikhanjung)

## Why CTHarvester?

Traditional CT processing software often requires loading entire datasets into memory, which can be problematic for:
- Large CT scans (several GB in size)
- Computers with limited RAM (8GB or less)
- Quick preview and region selection tasks
- Batch processing of multiple datasets

CTHarvester solves these issues by:
- Using Level of Detail (LoD) for fast, memory-efficient previews
- Processing only the selected regions of interest
- Streaming data slice-by-slice instead of loading everything at once
- Creating multi-resolution outputs for different analysis needs

## Acknowledgments

- Part of the PaleoBytes software suite
- Uses the marching cubes algorithm for 3D mesh generation
- Built with Qt for cross-platform compatibility
- Designed specifically for memory-constrained environments

## Support

For issues, questions, or suggestions, please [open an issue](https://github.com/jikhanjung/CTHarvester/issues) on GitHub.
