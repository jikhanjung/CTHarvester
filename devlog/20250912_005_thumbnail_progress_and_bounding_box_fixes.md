### 제목: 썸네일 생성 프로그레스 개선 및 바운딩 박스 스케일링 수정

- **날짜:** 2025-09-12
- **작성자:** Claude Code
- **관련 이슈:** 썸네일 생성 진행 상황 표시 개선, 레벨별 바운딩 박스 표시 오류 수정

### 1. 개요

썸네일 생성 과정의 사용자 경험 개선과 3D 뷰에서 레벨 변경 시 바운딩 박스가 올바르게 표시되지 않는 문제를 해결했습니다.

### 2. 주요 변경 사항

#### 2.1 멀티스레드 썸네일 생성 개선

##### 2.1.1 ThumbnailWorker 및 ThumbnailManager 클래스 추가
- **ThumbnailWorker**: 개별 썸네일 이미지 쌍 처리를 위한 QRunnable 워커
- **ThumbnailManager**: 멀티스레드 작업 조율 및 진행 상황 추적
- QThreadPool을 활용한 병렬 처리로 성능 향상

##### 2.1.2 통합 프로그레스 바
- 여러 LoD 레벨을 하나의 프로그레스 바로 통합 표시
- 전체 작업량 사전 계산으로 정확한 진행률 표시
- ETA(예상 완료 시간) 표시 기능 추가

##### 2.1.3 취소 기능
- 사용자가 썸네일 생성을 중단할 수 있는 Cancel 버튼 추가
- 작업 중단 시 안전한 정리 처리

#### 2.2 프로그레스 바 ETA 계산 개선

##### 2.2.1 정교한 ETA 알고리즘
```python
# 세 가지 추정 방법 결합
- 이동 평균: 최근 50개 작업의 가중 평균
- 전체 평균: 시작부터 현재까지의 평균
- 속도 기반: 최근 10개 작업의 처리 속도
```

##### 2.2.2 안정화 기법
- 지수 이동 평균(EMA) 적용 (30% 새 값, 70% 이전 값)
- 중앙값 사용으로 이상치 영향 최소화
- 워밍업 샘플 제외 (처음 3개)
- 5배 이상 느린 샘플 필터링

##### 2.2.3 레벨별 가중치
- 이미지 크기에 따른 처리 시간 가중치 계산
- 작은 이미지(높은 레벨)의 빠른 처리 반영

#### 2.3 프로그레스 메시지 일관성 개선

##### 2.3.1 메시지 통일
- "Creating rescaled images" → "Generating thumbnails"로 통일
- "Processing" / "Completed" 중복 표시 제거
- 레벨 정보 포함: "Generating thumbnails (Level N)"

##### 2.3.2 상세 로깅
- 각 프로그레스 업데이트마다 디버그 로그 추가
- 스레드풀 상태 및 워커 진행 상황 로깅
- 레벨별 작업 수 및 예상 시간 로깅

#### 2.4 썸네일 매니저 재사용 문제 수정

##### 2.4.1 문제점
- 첫 번째 스택 로드 후 두 번째 스택에서 프로그레스 업데이트 안 됨
- ThumbnailManager가 이전 progress_dialog 참조 유지

##### 2.4.2 해결책
- 매 스택 로드마다 새로운 ThumbnailManager 인스턴스 생성
- 항상 현재 progress_dialog 참조 사용

#### 2.5 바운딩 박스 스케일링 수정

##### 2.5.1 문제점
- 레벨 변경 시 바운딩 박스가 올바르게 스케일링되지 않음
- Original에서 Level 3으로 전환 시 바운딩 박스 사라짐
- ROI 박스가 전체 스택 대비 작게 표시

##### 2.5.2 원인 분석
- `minimum_volume`은 항상 가장 작은 레벨(최고 번호)의 데이터
- 바운딩 박스 계산 시 현재 레벨 고려 안 함
- ROI와 바운딩 박스 좌표계 불일치

##### 2.5.3 해결책
```python
# 스케일 팩터 계산
smallest_level_idx = len(self.level_info) - 1
level_diff = smallest_level_idx - self.curr_level_idx
scale_factor = 2 ** level_diff

# 바운딩 박스 차원 스케일링
scaled_depth = base_shape[0] * scale_factor
scaled_height = base_shape[1] * scale_factor
scaled_width = base_shape[2] * scale_factor
```

##### 2.5.4 ROI 스케일링
- get_cropped_volume()에서 ROI 좌표를 현재 레벨에 맞게 스케일링
- 모든 레벨에서 일관된 ROI 표시

### 3. 코드 변경 사항

#### 3.1 추가된 클래스
- `ThumbnailWorkerSignals`: 워커 시그널 정의
- `ThumbnailWorker`: 썸네일 처리 워커
- `ThumbnailManager`: 멀티스레드 관리자

#### 3.2 수정된 메서드
- `create_thumbnail()`: 멀티스레드 처리 적용
- `update_3D_view()`: 레벨별 스케일링 적용
- `update_curr_slice()`: 레벨별 스케일링 적용
- `get_cropped_volume()`: ROI 스케일링 추가
- `update_unified_progress()`: 정교한 ETA 계산

#### 3.3 추가된 메서드
- `calculate_total_thumbnail_work()`: 전체 작업량 계산
- `_calculate_eta()`: 다중 방법 ETA 계산
- `on_worker_progress()`: 워커 진행 상황 처리
- `on_worker_result()`: 워커 결과 처리
- `on_worker_finished()`: 워커 완료 처리

### 4. 성능 개선

#### 4.1 멀티스레딩
- QThreadPool 기본 4개 스레드 사용
- 병렬 이미지 처리로 전체 처리 시간 단축
- UI 응답성 유지

#### 4.2 메모리 효율성
- 스트리밍 방식 유지
- 필요한 이미지만 메모리에 로드

### 5. 사용자 경험 개선

#### 5.1 진행 상황 표시
- 통합된 단일 프로그레스 바
- 실시간 ETA 표시
- 레벨별 상세 정보 제공

#### 5.2 제어 기능
- 취소 버튼으로 작업 중단 가능
- 안정적인 ETA로 대기 시간 예측 가능

#### 5.3 3D 뷰 일관성
- 모든 레벨에서 올바른 바운딩 박스 표시
- ROI 선택 영역 정확한 표시

### 6. 버그 수정

#### 6.1 UnboundLocalError 수정
- `img_arrays` 변수 참조 순서 오류 수정
- 변수 정의 후 로그에서 참조하도록 변경

#### 6.2 Lambda 시그널 연결 문제
- `worker.signals.finished.connect(lambda: None)` 제거
- 적절한 슬롯 메서드로 교체

#### 6.3 스레드풀 초기화
- 메인 윈도우에서 스레드풀 초기화
- 최소 4개 스레드 보장

### 7. 향후 개선 사항

#### 7.1 추가 최적화
- GPU 가속 활용 가능성 검토
- 더 효율적인 이미지 압축 알고리즘 적용

#### 7.2 사용자 설정
- 스레드 수 조절 옵션
- ETA 표시 방식 선택

#### 7.3 에러 처리
- 개별 썸네일 실패 시 복구 로직 강화
- 부분 실패 시에도 전체 작업 계속 진행

### 8. 테스트 및 검증

#### 8.1 테스트 시나리오
- 다양한 크기의 CT 스택 테스트
- 레벨 전환 시 바운딩 박스 표시 확인
- 프로그레스 취소 기능 테스트

#### 8.2 성능 측정
- 멀티스레드 vs 단일스레드 처리 시간 비교
- 메모리 사용량 모니터링

### 9. 결론

이번 업데이트로 CTHarvester의 썸네일 생성 과정이 크게 개선되었습니다. 멀티스레딩을 통한 성능 향상, 정확한 진행 상황 표시, 안정적인 ETA 계산으로 사용자 경험이 향상되었으며, 레벨별 바운딩 박스 스케일링 문제 해결로 3D 뷰의 정확성도 개선되었습니다.

특히 대용량 CT 데이터 처리 시 사용자가 작업 진행 상황을 명확히 파악하고 필요시 중단할 수 있게 되어, 프로그램의 실용성이 크게 향상되었습니다.